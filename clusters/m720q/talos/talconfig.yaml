clusterName: talos-m720q
talosVersion: v1.11.5
kubernetesVersion: v1.32.0
endpoint: https://10.42.0.101:6443  # First control plane (Tailscale API proxy provides HA)

allowSchedulingOnControlPlanes: true

# No CNI - Cilium installed via Helm after bootstrap
cniConfig:
  name: none

nodes:
  - hostname: m720q-1
    ipAddress: 10.42.0.101
    controlPlane: true
    installDisk: /dev/nvme1n1      # Boot disk (2230 in wifi slot)
    disableSearchDomain: true
    networkInterfaces:
      - deviceSelector:
          driver: ixgbe            # Intel 10G SFP+
        dhcp: true

  - hostname: m720q-2
    ipAddress: 10.42.0.102
    controlPlane: true
    installDisk: /dev/nvme1n1
    disableSearchDomain: true
    networkInterfaces:
      - deviceSelector:
          driver: mlx4_en          # Mellanox ConnectX-3
        dhcp: true

  - hostname: m720q-3
    ipAddress: 10.42.0.103
    controlPlane: true
    installDisk: /dev/nvme1n1
    disableSearchDomain: true
    networkInterfaces:
      - deviceSelector:
          driver: ixgbe            # Intel 10G SFP+
        dhcp: true

controlPlane:
  patches:
    - |-
      cluster:
        allowSchedulingOnMasters: true
        proxy:
          disabled: true           # Cilium replaces kube-proxy
        discovery:
          enabled: true
        etcd:
          extraArgs:
            listen-metrics-urls: http://0.0.0.0:2381
      machine:
        features:
          kubePrism:
            enabled: true
            port: 7445
          hostDNS:
            enabled: true
            forwardKubeDNSToHost: true
        kubelet:
          extraArgs:
            rotate-server-certificates: true
